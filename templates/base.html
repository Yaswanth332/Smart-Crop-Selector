{% load static %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}AgriSmart | Crop Advisor{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Preload critical fonts & CSS for performance -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Open+Sans:wght@400;600;700&family=Montserrat:wght@700;800&display=swap" as="style" onload="this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" as="style" onload="this.rel='stylesheet'">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Open+Sans:wght@400;600;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </noscript>

    <!-- Non-critical CSS (AOS, FontAwesome) preload -->
    <link rel="preload" href="https://unpkg.com/aos@2.3.1/dist/aos.css" as="style" onload="this.rel='stylesheet'">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.rel='stylesheet'">

    <style>
        /* =========================
           Theme & Color system
           ========================= */
        :root{
            --primary-color: #2E8B57;
            --primary-light: #3CB371;
            --primary-dark: #1E6B3E;
            --accent: #FFA500;
            /* --bg-overlay: rgba(255,255,255,0.78); -- Removed as per request */
            /* --bg-overlay-dark: rgba(14,40,14,0.7); -- Removed as per request */
            --text-dark: #213043;
            --text-light: #FAFAFA;
            --card-radius: 14px;
            --shadow-sm: 0 4px 14px rgba(0,0,0,0.06);
            --shadow-md: 0 10px 30px rgba(0,0,0,0.10);
            --trans: 0.28s cubic-bezier(.25,.8,.25,1);
        }

        /* Reset + base */
        *,*::before,*::after{box-sizing:border-box}
        html,body{height:100%}
        body{
            font-family: 'Open Sans', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            margin:0;
            color:var(--text-dark);
            line-height:1.6;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            /* Background image (separate + overlay via pseudo element) */
            background-image: url("{% static 'images/farm-landscape.jpg' %}");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            position: relative;
            min-height:100vh;
        }

        [data-bs-theme="dark"] body{
            background-image: url("{% static 'images/farm-night.jpg' %}");
            color:var(--text-light);
        }

        /* Headings */
        h1,h2,h3,h4{font-family:'Poppins',sans-serif; margin-bottom:.75rem}
        h1{font-size:2.75rem; font-weight:800; letter-spacing:-0.5px;
            background:linear-gradient(90deg,var(--primary-color),var(--primary-light));
            -webkit-background-clip:text; background-clip:text; color:transparent;
        }
        h2{font-size:1.9rem; color:var(--primary-dark); position:relative; display:inline-block}
        h2::after{ content:''; position:absolute; height:4px; width:56px; left:0; bottom:-8px;
            border-radius:3px; background:linear-gradient(90deg,var(--primary-color),var(--accent));}

        /* Container for page content, with animation */
        .page-content-wrapper{ min-height:100vh; padding:1.5rem 0; animation: slideUp .6s var(--trans) both;}
        @keyframes slideUp{ from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:none} }

        /* =========================
           Navbar (glass + sticky)
           ========================= */
        nav[role="navigation"]{ /* using bootstrap classes but overriding */
            position: sticky;
            top: 0;
            z-index: 1030; /* High z-index to stay on top */
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(46,139,87,0.07);
            box-shadow: var(--shadow-sm);
            padding: .7rem 1rem;
            transition: all var(--trans);
            border-radius: 0; /* Ensures it's a full-width bar */
        }
        [data-bs-theme="dark"] nav[role="navigation"]{
            background: rgba(10,30,10,0.72);
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .navbar-brand{ font-family:'Montserrat', sans-serif; font-weight:800; font-size:1.55rem; display:flex; align-items:center; gap:.5rem; color:var(--primary-dark); text-decoration:none}
        [data-bs-theme="dark"] .navbar-brand{ color:var(--accent); }

        .brand-icon{ font-size:1.6rem; display:inline-flex; align-items:center; justify-content:center; transform-origin:center; }
        .brand-icon.animate-float{ animation: float 6s ease-in-out infinite; }
        @keyframes float{ 0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)} }

        .navbar-nav .nav-link{
            font-weight:600; padding:.45rem .9rem; border-radius:10px; margin:0 .25rem; color:inherit;
            transition: transform var(--trans), background var(--trans);
        }
        .navbar-nav .nav-link:focus{ outline: 3px solid rgba(46,139,87,0.18); outline-offset:3px; border-radius:10px; }
        .navbar-nav .nav-link:hover{ transform:translateY(-3px); background: rgba(46,139,87,0.06); }
        .nav-link.active{ background: linear-gradient(135deg, rgba(46,139,87,0.14), rgba(60,179,113,0.10)); color:var(--primary-dark); box-shadow:none; }

        /* Improved toggler visuals for mobile */
        .navbar-toggler{ border-radius:10px; border: none; padding:.35rem .6rem; }
        .navbar-toggler:focus{ box-shadow: 0 0 0 4px rgba(46,139,87,0.12); }

        /* Mobile nav layout: stack items in collapse */
        @media (max-width: 768px){
            .navbar-brand{ font-size:1.35rem; }
            .navbar-nav{ gap:.4rem; }
            .nav-link{ padding:.6rem 1rem !important; margin:.2rem 0; display:block; width:100%; }
            nav[role="navigation"]{ padding:.6rem .7rem; }
        }

        /* =========================
           Cards (subtle glass + hover)
           ========================= */
        .card{
            border:none; border-radius:var(--card-radius); overflow:hidden;
            background: rgba(255,255,255,0.92); box-shadow:var(--shadow-sm); transition: transform var(--trans), box-shadow var(--trans);
            backdrop-filter: blur(8px);
        }
        [data-bs-theme="dark"] .card{ background: rgba(12,28,12,0.6); }
        .card:hover{ transform: translateY(-6px); box-shadow:var(--shadow-md); }
        .card-header{ background: linear-gradient(135deg,var(--primary-color),var(--primary-light)); color:white; font-weight:700; border-bottom:none; padding:1rem 1.2rem;}
        .card-body{ padding:1.25rem; }

        /* =========================
           Forms
           ========================= */
        .form-label{ font-weight:600; color:var(--primary-dark); margin-bottom:.35rem; display:inline-block; }
        [data-bs-theme="dark"] .form-label{ color:var(--accent); }

        .form-control{
            border: 2px solid rgba(46,139,87,0.12);
            border-radius:10px; padding:.65rem .9rem; transition: box-shadow var(--trans), border-color var(--trans), background var(--trans);
            background: rgba(255,255,255,0.92);
        }
        [data-bs-theme="dark"] .form-control{ background: rgba(0,0,0,0.22); border-color: rgba(255,255,255,0.06); color:var(--text-light); }
        .form-control:focus{
            outline:none; border-color:var(--primary-color);
            box-shadow: 0 6px 18px rgba(46,139,87,0.12);
            background: #fff;
        }
        [data-bs-theme="dark"] .form-control:focus{ background: rgba(0,0,0,0.28); box-shadow: 0 6px 18px rgba(255,215,0,0.08); }

        /* Buttons */
        .btn{ border-radius:10px; font-weight:700; letter-spacing:.6px; transition: transform var(--trans), box-shadow var(--trans); }
        .btn-primary{ background: linear-gradient(135deg,var(--primary-color),var(--primary-light)); border:none; color:white; padding:.6rem 1rem; }
        .btn-primary:hover{ transform: translateY(-3px); box-shadow:var(--shadow-md); }
        .btn-outline-primary{ border:2px solid var(--primary-color); color:var(--primary-color); background:transparent; }
        .btn-outline-primary:hover{ background:var(--primary-color); color:#fff; }

        /* Focus states for keyboard users */
        a:focus, button:focus, .form-control:focus{ outline-offset:3px }

        /* Animations (subtle) */
        .animate-fade{ animation: fadeIn .6s var(--trans) both; }
        @keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

        /* Responsive typography */
        @media (max-width: 992px){
            h1{ font-size:2.4rem }
            h2{ font-size:1.5rem }
        }

        /* Custom scrollbar for modern browsers */
        ::-webkit-scrollbar{ width:10px }
        ::-webkit-scrollbar-thumb{ background:var(--primary-color); border-radius:8px; }
        [data-bs-theme="dark"] ::-webkit-scrollbar-thumb{ background:var(--accent); }

        /* Small utility */
        .ms-2s{ margin-left:.5rem }
    </style>

    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Navbar -->
    <nav role="navigation" class="navbar navbar-expand-lg" aria-label="Main navigation">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'home' %}" aria-label="AgriSmart Home">
                <span class="brand-icon animate-float" aria-hidden="true">🌱</span>
                <span>AgriSmart</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon" aria-hidden="true"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}"
                           href="{% url 'home' %}">
                            <i class="fas fa-home me-1" aria-hidden="true"></i> Home
                        </a>
                    </li>
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'recommend' %}active{% endif %}"
                               href="{% url 'recommend' %}">
                                <i class="fas fa-seedling me-1" aria-hidden="true"></i> Crop Advisor
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'past_recommendations' %}active{% endif %}"
                               href="{% url 'past_recommendations' %}">
                                <i class="fas fa-history me-1" aria-hidden="true"></i> My Farm Log
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'logout' %}">
                                <i class="fas fa-sign-out-alt me-1" aria-hidden="true"></i> Logout ({{ user.username }})
                            </a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'register' %}active{% endif %}"
                               href="{% url 'register' %}">
                                <i class="fas fa-user-plus me-1" aria-hidden="true"></i> Register
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'login' %}active{% endif %}"
                               href="{% url 'login' %}">
                                <i class="fas fa-sign-in-alt me-1" aria-hidden="true"></i> Login
                            </a>
                        </li>
                    {% endif %}

                    <!-- Theme Toggle (keeps a11y in mind) -->
                    <li class="nav-item">
                        <button id="toggleTheme" class="btn btn-sm ms-2s" aria-pressed="false" aria-label="Toggle theme" title="Toggle Theme">
                            <i class="fas fa-moon" id="theme-icon" aria-hidden="true"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div class="page-content-wrapper">
        <!-- Main Content -->
        <main class="container">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show animate-fade" role="alert" aria-live="polite">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            {% block content %}{% endblock %}
        </main>

        <!-- Footer -->
        <footer class="mt-5 py-4 text-center" role="contentinfo">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <p class="mb-0 text-muted small" aria-hidden="false">
                            &copy; {% now "Y" %} AgriSmart - Smart Farming Solutions
                        </p>
                        <div class="mt-2" aria-hidden="true">
                            <a href="#" class="text-decoration-none me-3" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="text-decoration-none me-3" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="text-decoration-none me-3" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                            <a href="#" class="text-decoration-none" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- JS: deferred for performance -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
        // Wait for DOMContentLoaded to attach event handlers (deferred resources loaded earlier)
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize AOS (Animate On Scroll) if available
            if (window.AOS) {
                AOS.init({ duration: 700, easing: 'ease-in-out', once: true });
            }

            // Theme Toggle (persisted, accessible)
            const html = document.documentElement;
            const toggle = document.getElementById('toggleTheme');
            const icon = document.getElementById('theme-icon');

            // Load saved theme (ensure valid)
            const saved = localStorage.getItem('agriSmartTheme');
            const theme = (saved === 'dark' || saved === 'light') ? saved : 'light';
            html.setAttribute('data-bs-theme', theme);
            updateIcon(theme);

            toggle.addEventListener('click', function (e) {
                const current = html.getAttribute('data-bs-theme') || 'light';
                const next = current === 'light' ? 'dark' : 'light';
                html.setAttribute('data-bs-theme', next);
                localStorage.setItem('agriSmartTheme', next);
                updateIcon(next);

                // accessibility: update aria-pressed
                const pressed = toggle.getAttribute('aria-pressed') === 'true';
                toggle.setAttribute('aria-pressed', (!pressed).toString());

                // subtle feedback
                toggle.classList.add('animate__animated', 'animate__pulse');
                setTimeout(() => toggle.classList.remove('animate__animated', 'animate__pulse'), 650);
            });

            function updateIcon(theme) {
                if (theme === 'dark') {
                    icon.className = 'fas fa-sun';
                    icon.style.color = '#FFD700';
                } else {
                    icon.className = 'fas fa-moon';
                    icon.style.color = '#2E8B57';
                }
            }

            // Smooth scrolling for anchors (only internal anchors)
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    const href = this.getAttribute('href');
                    if (!href || href === '#') return;
                    const target = document.querySelector(href);
                    if (target) {
                        e.preventDefault();
                        const top = Math.max(target.getBoundingClientRect().top + window.scrollY - 80, 0);
                        window.scrollTo({ top, behavior: 'smooth' });
                        target.focus({ preventScroll: true });
                    }
                });
            });

            // Intersection animation (for cards)
            const cards = document.querySelectorAll('.card');
            if ('IntersectionObserver' in window) {
                const io = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) entry.target.classList.add('animate-fade');
                    });
                }, { threshold: 0.12 });
                cards.forEach(c => io.observe(c));
            } else {
                cards.forEach(c => c.classList.add('animate-fade'));
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>