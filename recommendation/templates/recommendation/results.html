{% extends 'recommendation/base.html' %}

{% block title %}Recommended Crops{% endblock %}

{% block extra_head %}
<style>
    :root {
        --primary: #2e7d32;
        --primary-light: #4caf50;
        --primary-dark: #1b5e20;
    }

    body {
        padding-bottom: 80px; /* Add padding for sticky footer */
    }

    /* --- Spotify-Inspired Card --- */
    .crop-card {
        transition: all 0.3s ease;
        border: 1px solid rgba(0,0,0,0.1);
        background: #fff;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .crop-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .card-img-container {
        position: relative;
    }
    .card-img-top {
        height: 200px;
        object-fit: cover;
    }

    /* --- Match Score Progress Bar --- */
    .match-score-bar {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-dark);
    }
    .progress {
        height: 8px;
        background-color: rgba(0,0,0,0.1);
    }

    /* --- Quick Actions --- */
    .quick-actions-bar {
        border-top: 1px solid rgba(0,0,0,0.1);
        padding-top: 0.75rem;
        margin-top: 1rem;
    }
    .btn-quick-action {
        font-size: 1.1rem;
        padding: 0.25rem 0.5rem;
        line-height: 1;
        color: #6c757d;
        background: transparent;
        border: none;
    }
    .btn-quick-action:hover {
        color: var(--primary);
    }

    /* --- Collapsible Query Summary --- */
    #query-summary-card .card-header {
        padding: 0;
    }
    #query-summary-card .btn-toggle {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-dark);
        text-decoration: none;
        width: 100%;
        text-align: left;
        padding: 1rem 1.25rem;
        box-shadow: none;
    }
    #query-summary-card .btn-toggle:hover {
        background-color: rgba(0,0,0,0.03);
    }
    #query-summary-card .btn-toggle::after {
        content: '‚ñ≤';
        float: right;
        transition: transform 0.3s ease;
    }
    #query-summary-card .btn-toggle.collapsed::after {
        transform: rotate(180deg);
    }

    /* --- Carousel for Recommendations --- */
    .recommend-carousel-container {
        display: flex;
        overflow-x: auto;
        gap: 1.5rem;
        padding: 1rem 0;
        scrollbar-width: none; /* For Firefox */
    }
    .recommend-carousel-container::-webkit-scrollbar {
        display: none; /* For Chrome, Safari, and Opera */
    }
    .crop-card-wrapper {
        flex: 0 0 320px;
        max-width: 320px;
    }
    @media (max-width: 768px) {
        .crop-card-wrapper {
            flex: 0 0 280px;
            max-width: 280px;
        }
    }

    /* --- Sticky Footer --- */
    .sticky-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-around;
        padding: 0.5rem 0;
        z-index: 1030;
        border-top: 1px solid rgba(0,0,0,0.1);
    }
    .footer-link {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: #6c757d;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .footer-link i {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
    }
    .footer-link.active, .footer-link:hover {
        color: var(--primary);
    }
    @media (min-width: 768px) {
        .sticky-footer {
            display: none; /* Hide on larger screens */
        }
        body {
            padding-bottom: 0;
        }
    }
    
    /* --- Dark Mode Enhancements --- */
    [data-bs-theme="dark"] .crop-card,
    [data-bs-theme="dark"] #query-summary-card,
    [data-bs-theme="dark"] .sticky-footer {
        background-color: rgba(33, 37, 41, 0.85);
        border-color: rgba(255, 255, 255, 0.20);
        backdrop-filter: blur(10px);
    }
    [data-bs-theme="dark"] .crop-card:hover {
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    }
    [data-bs-theme="dark"] .btn-toggle,
    [data-bs-theme="dark"] .card-title {
        color: #eee;
    }
    [data-bs-theme="dark"] .quick-actions-bar {
        border-top-color: rgba(255, 255, 255, 0.20);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Collapsible Query Summary -->
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            {% if query %}
            <div class="card mb-4 shadow-sm" id="query-summary-card">
                <div class="card-header" id="query-summary-header">
                    <button class="btn btn-toggle collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseQuery" aria-expanded="false" aria-controls="collapseQuery">
                        üìä Your Conditions
                    </button>
                </div>
                <div id="collapseQuery" class="collapse" aria-labelledby="query-summary-header">
                    <div class="card-body">
                        <small class="text-muted">Query from {{ query.created_at|date:"M d, Y" }} | {{ total_found }} matches found</small>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <strong>üå± Field:</strong>
                                <ul class="list-unstyled small">
                                    <li>Soil: {{ query.soil_texture|capfirst }}</li>
                                    <li>pH: {{ query.soil_ph }}</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <strong>üå¶Ô∏è Climate:</strong>
                                <ul class="list-unstyled small">
                                    <li>Rainfall: {{ query.rainfall_mm }} mm</li>
                                    <li>Temp: {{ query.avg_temperature }}¬∞C</li>
                                </ul>
                            </div>
                             <div class="col-md-4">
                                <strong>üìã Other:</strong>
                                <ul class="list-unstyled small">
                                     <li>Season: {{ query.season|capfirst }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recommendations Carousel -->
    <h2 class="mb-3">
        {% if is_past_query %}Past Recommendations{% else %}Top Recommendations{% endif %}
    </h2>
    <div class="recommend-carousel-container">
        {% for crop in crops %}
        <div class="crop-card-wrapper">
            <div class="card h-100 shadow-sm crop-card">
                <div class="card-img-container">
                    {% if crop.image %}
                        <img src="{{ crop.image.url }}" class="card-img-top" alt="{{ crop.name }}">
                    {% else %}
                        <img src="https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?auto=format&fit=crop&w=400&h=200&q=80" class="card-img-top" alt="{{ crop.name }}">
                    {% endif %}
                </div>
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ crop.name }}</h5>
                    
                    <!-- Match Score Progress Bar -->
                    {% if crop.score %}
                    <div class="match-score-bar mb-2">
                        <span>Match: {{ crop.score }}/8</span>
                        <div class="progress">
                            <div class="progress-bar {% if crop.score >= 7 %}bg-success{% elif crop.score >= 5 %}bg-warning{% else %}bg-info{% endif %}" role="progressbar" style="width: {% widthratio crop.score 8 100 %}%" aria-valuenow="{{ crop.score }}" aria-valuemin="0" aria-valuemax="8"></div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <p class="card-text small text-muted flex-grow-1">{{ crop.description|truncatewords:20 }}</p>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions-bar">
                         <div class="d-flex justify-content-between align-items-center">
                            <a href="{% url 'crop_detail' crop.id %}" class="btn btn-primary btn-sm flex-grow-1 me-2">View Details</a>
                            <div class="d-flex">
                                <button class="btn-quick-action" title="Save"><i class="fas fa-bookmark"></i></button>
                                <button class="btn-quick-action" title="Compare"><i class="fas fa-exchange-alt"></i></button>
                                <button class="btn-quick-action" title="Share"><i class="fas fa-share-alt"></i></button>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="card shadow-sm text-center py-5">
                <h4>üòî No Perfect Matches Found</h4>
                <p class="text-muted">Try adjusting your criteria for better results.</p>
                <div class="mt-3">
                     <a href="{% url 'recommend' %}" class="btn btn-success">üîÑ Try Different Conditions</a>
                </div>
                
                <!-- Empty State Upgrade -->
                <h5 class="mt-5">Alternative Crop Suggestions</h5>
                <p class="text-muted small">Consider these popular crops for your region</p>
                <!-- Placeholder for alternative crops -->
            </div>
        </div>
        {% endfor %}
    </div>

     <div class="text-center mt-5 d-none d-md-block"> <!-- Hide on mobile -->
        <a href="{% url 'recommend' %}" class="btn btn-success">üîÑ New Recommendation</a>
        <a href="{% url 'past_recommendations' %}" class="btn btn-info">üìã View History</a>
    </div>
</div>

<!-- Sticky Footer for Mobile -->
<nav class="sticky-footer">
    <a href="{% url 'home' %}" class="footer-link"><i class="fas fa-home"></i> Home</a>
    <a href="{% url 'recommend' %}" class="footer-link active"><i class="fas fa-seedling"></i> Recommend</a>
    <a href="#" class="footer-link"><i class="fas fa-bookmark"></i> Saved</a>
    <a href="{% url 'past_recommendations' %}" class="footer-link"><i class="fas fa-history"></i> History</a>
</nav>
{% endblock %}

